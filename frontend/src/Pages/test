import React, { useState, useEffect } from 'react';

function ResultsPage() {
  // ุงูุญุงูุฉ ุงูุนุงูุฉ
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);

  // ููุฏุงูุงุช
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [showRegisterModal, setShowRegisterModal] = useState(false);
  const [showCommandeModal, setShowCommandeModal] = useState(false);

  // ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู
  const [loginData, setLoginData] = useState({ email: '', password: '' });
  // ุจูุงูุงุช ุงูุชุณุฌูู
  const [registerData, setRegisterData] = useState({
    name: '',
    email: '',
    password: '',
    password_confirmation: '',
  });

  // ุจูุงูุงุช ุงูุทูุจ
  const [commandeData, setCommandeData] = useState({
    nom: '',
    prenom: '',
    telephone: '',
    adresse: '',
    immobilier_id: null,
  });

  // ููุฏุงู ุงูุฑุณุงุฆู
  const [messageModal, setMessageModal] = useState({ visible: false, text: '' });

  // ุงูุนูุงุฑ ุงููุฎุชุงุฑ
  const [selectedProperty, setSelectedProperty] = useState(null);

  // ุฌูุจ ุงููุชุงุฆุฌ ูู localStorage
  useEffect(() => {
    const storedResults = localStorage.getItem('immobilierResults');
    if (storedResults) {
      setResults(JSON.parse(storedResults));
    }
  }, []);

  // ูุชุญ ููุฏุงู ุงูุทูุจ ูุน ุชุนููู immobilier_id
  const openCommandeModal = (immobilier) => {
    setCommandeData({
      nom: '',
      prenom: '',
      telephone: '',
      adresse: '',
      immobilier_id: immobilier.id,
    });
    setShowCommandeModal(true);
  };

  // ุฏูุงู ููุฏุงู ุงูุฑุณุงุฆู
  const showMessage = (msg) => setMessageModal({ visible: true, text: msg });
  const closeMessage = () => setMessageModal({ visible: false, text: '' });

  // ุชุณุฌูู ุงูุฏุฎูู
  const handleLoginSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const res = await fetch('http://localhost:8000/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(loginData),
      });
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem('auth_token', data.access_token);
        showMessage('ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ');
        setShowLoginModal(false);
        setShowCommandeModal(true);
        setLoginData({ email: '', password: '' });
      } else {
        showMessage(data.message || 'ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู');
      }
    } catch (error) {
      showMessage('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
    }
    setLoading(false);
  };

  // ุงูุชุณุฌูู
  const handleRegisterSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const res = await fetch('http://localhost:8000/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(registerData),
      });
      const data = await res.json();
      if (res.ok) {
        showMessage('ุชู ุงูุชุณุฌูู ุจูุฌุงุญุ ููููู ุชุณุฌูู ุงูุฏุฎูู ุงูุขู');
        setShowRegisterModal(false);
        setShowLoginModal(true);
        setRegisterData({ name: '', email: '', password: '', password_confirmation: '' });
      } else {
        showMessage(
          typeof data === 'object'
            ? Object.values(data).flat().join('\n')
            : data.message || 'ุฎุทุฃ ูู ุงูุชุณุฌูู'
        );
      }
    } catch (error) {
      showMessage('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
    }
    setLoading(false);
  };

  // ุฅุฑุณุงู ุงูุทูุจ
  const handleCommandeSubmit = async (e) => {
    e.preventDefault();
    const token = localStorage.getItem('auth_token');
    if (!token) {
      showMessage('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุง');
      setShowCommandeModal(false);
      setShowLoginModal(true);
      return;
    }
    setLoading(true);
    try {
      const res = await fetch('http://localhost:8000/api/demandes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(commandeData),
      });
      const data = await res.json();
      if (res.ok) {
        showMessage('ุชู ุฅุฑุณุงู ุงูุทูุจ ุจูุฌุงุญ');
        localStorage.removeItem('auth_token'); // ุชุณุฌูู ุฎุฑูุฌ ุชููุงุฆู
        window.location.href = '/';
      } else {
        showMessage(data.message || 'ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุทูุจ');
      }
    } catch (error) {
      showMessage('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
    }
    setLoading(false);
    setShowCommandeModal(false);
  };

  return (
    <div>
      <h2>ูุชุงุฆุฌ ุงูุจุญุซ</h2>
      <hr />
      <div className="properties-grid">
        {results.length === 0 && <p>ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>}
        {results.map((item) => (
          <div className="property-card" key={item.id}>
            <div className="property-image">
              ๐
              <span className={`property-status ${item.etat.toLowerCase()}`}>
                {item.etat}
              </span>
            </div>
            <div className="property-content">
              <h3>{item.type}</h3>
              <div>๐ {item.ville}</div>
              <div>
                <span>{item.nbr_chambres} ุบุฑู</span> -{' '}
                <span>{item.nbr_salles_bain} ุญูุงูุงุช</span> -{' '}
                <span>{item.surface} ูยฒ</span>
              </div>
              <div>{item.prix.toLocaleString()} ุฏุฑูู</div>
              <div>
                <button
                  onClick={() => {
                    if (item.etat === 'vendue') {
                      showMessage('ุนุฐุฑุงูุ ูุฐุง ุงูุนูุงุฑ ูุจุงุน');
                    } else {
                      openCommandeModal(item);
                    }
                  }}
                >
                  ุทูุจ
                </button>
                <button onClick={() => setSelectedProperty(item)}>ุชูุงุตูู</button>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* ููุฏุงู ุงูุชูุงุตูู */}
      {selectedProperty && (
        <div className="details-modal">
          <div className="details-modal-content">
            <h3>ุชูุงุตูู ุงูุนูุงุฑ</h3>
            <p>ุงูููุน: {selectedProperty.type}</p>
            <p>ุงููุฏููุฉ: {selectedProperty.ville}</p>
            <p>ุนุฏุฏ ุงูุบุฑู: {selectedProperty.nbr_chambres}</p>
            <p>ุนุฏุฏ ุงูุญูุงูุงุช: {selectedProperty.nbr_salles_bain}</p>
            <p>ุงููุณุงุญุฉ: {selectedProperty.surface} ูยฒ</p>
            <p>ุงูุญุงูุฉ: {selectedProperty.etat}</p>
            <p>ุงูุณุนุฑ: {selectedProperty.prix.toLocaleString()} ุฏุฑูู</p>
            <button onClick={() => setSelectedProperty(null)}>ุฅุบูุงู</button>
          </div>
        </div>
      )}

      {/* ููุฏุงู ุชุณุฌูู ุงูุฏุฎูู */}
      {showLoginModal && (
        <div className="modal">
          <div className="modal-content">
            <h3>ุชุณุฌูู ุงูุฏุฎูู</h3>
            <form onSubmit={handleLoginSubmit}>
              <input
                type="email"
                placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"
                value={loginData.email}
                onChange={(e) => setLoginData({ ...loginData, email: e.target.value })}
                required
              />
              <input
                type="password"
                placeholder="ูููุฉ ุงูุณุฑ"
                value={loginData.password}
                onChange={(e) => setLoginData({ ...loginData, password: e.target.value })}
                required
              />
              <button type="submit" disabled={loading}>
                {loading ? 'ุฌุงุฑู ุงูุฅุฑุณุงู...' : 'ุชุณุฌูู ุงูุฏุฎูู'}
              </button>
              <button type="button" onClick={() => setShowLoginModal(false)}>
                ุฅูุบุงุก
              </button>
            </form>
            <p>
              ูุง ุนูุฏูุด ุญุณุงุจุ{' '}
              <span
                style={{ color: 'blue', cursor: 'pointer' }}
                onClick={() => {
                  setShowLoginModal(false);
                  setShowRegisterModal(true);
                }}
              >
                ุณุฌู ููุง
              </span>
            </p>
          </div>
        </div>
      )}

      {/* ููุฏุงู ุงูุชุณุฌูู */}
      {showRegisterModal && (
        <div className="modal">
          <div className="modal-content">
            <h3>ุงูุชุณุฌูู</h3>
            <form onSubmit={handleRegisterSubmit}>
              <input
                type="text"
                placeholder="ุงูุงุณู ุงููุงูู"
                value={registerData.name}
                onChange={(e) => setRegisterData({ ...registerData, name: e.target.value })}
                required
              />
              <input
                type="email"
                placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"
                value={registerData.email}
                onChange={(e) => setRegisterData({ ...registerData, email: e.target.value })}
                required
              />
              <input
                type="password"
                placeholder="ูููุฉ ุงูุณุฑ"
                value={registerData.password}
                onChange={(e) => setRegisterData({ ...registerData, password: e.target.value })}
                required
              />
              <input
                type="password"
                placeholder="ุชุฃููุฏ ูููุฉ ุงูุณุฑ"
                value={registerData.password_confirmation}
                onChange={(e) =>
                  setRegisterData({ ...registerData, password_confirmation: e.target.value })
                }
                required
              />
              <button type="submit" disabled={loading}>
                {loading ? 'ุฌุงุฑู ุงูุฅุฑุณุงู...' : 'ุงูุชุณุฌูู'}
              </button>
              <button type="button" onClick={() => setShowRegisterModal(false)}>
                ุฅูุบุงุก
              </button>
            </form>
            <p>
              ุนูุฏู ุญุณุงุจุ{' '}
              <span
                style={{ color: 'blue', cursor: 'pointer' }}
                onClick={() => {
                  setShowRegisterModal(false);
                  setShowLoginModal(true);
                }}
              >
                ุณุฌู ุงูุฏุฎูู
              </span>
            </p>
          </div>
        </div>
      )}

      {/* ููุฏุงู ุงูุทูุจ */}
      {showCommandeModal && (
        <div className="modal">
          <div className="modal-content">
            <h3>ุทูุจ ุนูุงุฑ</h3>
            <form onSubmit={handleCommandeSubmit}>
              <input
                type="text"
                placeholder="ุงูุงุณู"
                value={commandeData.nom}
                onChange={(e) => setCommandeData({ ...commandeData, nom: e.target.value })}
                required
              />
              <input
                type="text"
                placeholder="ุงูููุจ"
                value={commandeData.prenom}
                onChange={(e) => setCommandeData({ ...commandeData, prenom: e.target.value })}
                required
              />
              <input
                type="tel"
                placeholder="ุฑูู ุงููุงุชู"
                value={commandeData.telephone}
                onChange={(e) => setCommandeData({ ...commandeData, telephone: e.target.value })}
                required
              />
              <input
                type="text"
                placeholder="ุงูุนููุงู"
                value={commandeData.adresse}
                onChange={(e) => setCommandeData({ ...commandeData, adresse: e.target.value })}
                required
              />
              <button type="submit" disabled={loading}>
                {loading ? 'ุฌุงุฑู ุงูุฅุฑุณุงู...' : 'ุฅุฑุณุงู ุงูุทูุจ'}
              </button>
              <button type="button" onClick={() => setShowCommandeModal(false)}>
                ุฅูุบุงุก
              </button>
            </form>
          </div>
        </div>
      )}

      {/* ููุฏุงู ุงูุฑุณุงุฆู */}
      {messageModal.visible && (
        <div className="message-modal">
          <div className="message-content">
            <p>{messageModal.text}</p>
            <button onClick={closeMessage}>ุญุณูุงู</button>
          </div>
        </div>
      )}
    </div>
  );
}

export default ResultsPage;
